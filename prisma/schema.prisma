generator client {
  provider = "prisma-client-js"
}
// Force git update for Vercel
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Standard connection string
  directUrl = env("DIRECT_URL") // Direct connection for migrations
}

model Agency {
  id        String   @id @default(cuid())
  name      String   @unique // e.g. "Dallas PD"
  timezone  String   @default("America/Chicago")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  employees             Employee[]
  shifts                Shift[]
  assetCategories       AssetCategory[]
  assets                Asset[]
  trainings             Training[]
  certificates          Certificate[]
  policies              Policy[]
  formTemplates         FormTemplate[]
  organizationSettings  OrganizationSettings?
  auditLogs             AuditLog[]
}

model Employee {
  empId    Int     @id @default(autoincrement())
  agencyId String?
  agency   Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  empName  String?
  departed Boolean @default(false)

  attendances Attendance[]
  expirations Expiration[]
  policyAcknowledgments PolicyAcknowledgment[]
  assetAssignments AssetAssignment[]
  formResponses FormResponse[] @relation("Trainee")
  flags       EISFlag[]
  user        User?
  
  shiftId     Int?
  shift       Shift?   @relation(fields: [shiftId], references: [id])
}

model Shift {
  id       Int     @id @default(autoincrement())
  agencyId String?
  agency   Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  
  name     String  // Removed @unique so multiple agencies can have a "A" shift
  
  employees Employee[]

  @@unique([agencyId, name])
}

model AssetCategory {
  id          Int      @id @default(autoincrement())
  agencyId    String?
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Radio", "Firearm", "Vehicle"
  description String?
  
  assets      Asset[]
}

model Asset {
  id          Int      @id @default(autoincrement())
  agencyId    String?
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Motorola APX 6000"
  serialNumber String? 
  assetTag    String?  // Internal barcode/tag
  
  categoryId  Int
  category    AssetCategory @relation(fields: [categoryId], references: [id])
  
  status      String   @default("AVAILABLE") // AVAILABLE, ASSIGNED, MAINTENANCE, RETIRED, LOST
  condition   String   @default("GOOD")      // NEW, GOOD, FAIR, POOR, DAMAGED
  
  purchaseDate DateTime?
  cost         Float?
  
  assignments AssetAssignment[]
}

model AssetAssignment {
  id          Int      @id @default(autoincrement())
  assetId     Int
  employeeId  Int
  
  assignedAt  DateTime @default(now())
  returnedAt  DateTime?
  
  assignedByUserId Int? 
  
  notes       String?
  
  asset       Asset    @relation(fields: [assetId], references: [id])
  employee    Employee @relation(fields: [employeeId], references: [empId], onDelete: Cascade, onUpdate: Cascade)
}

model User {
  id        Int      @id @default(autoincrement())
  agencyId  String?
  agency    Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  email     String   @unique
  password  String
  name      String
  role      String   @default("TRAINEE") // 'SUPERUSER', 'TRAINEE', 'ADMIN', 'SUPERVISOR', 'TRAINER'
  customPermissions String?  // JSON array of strings
  
  twoFactorSecret String?
  twoFactorEnabled Boolean @default(false)
  forcePasswordReset Boolean @default(false)

  employee  Employee? @relation(fields: [empId], references: [empId], onDelete: SetNull, onUpdate: Cascade)
  empId     Int?     @unique
  authoredTrainerResponses FormResponse[] @relation("Trainer")
  auditLogs AuditLog[]
}

model RoleTemplate {
  id          Int      @id @default(autoincrement())
  roleName    String   @unique // 'SUPERVISOR', 'TRAINER'
  permissions String   // JSON array of strings: ["view_reports", "manage_inventory"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Training {
  TrainingID   Int     @id @default(autoincrement())
  agencyId     String?
  agency       Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  TrainingName String?
  category     String? // CEU Bucket (e.g. "Medical", "Fire", "Law")
  filePath     String? // Path to syllabus or training materials

  attendances Attendance[]
  exclusions  CertificateTrainingExclusion[]
}

model Attendance {
  attendanceID    Int       @id @default(autoincrement())
  attendanceDate  DateTime?
  attendanceHealth Boolean?
  attendanceHours Float?
  attendanceNote  String? // Note: Access text fields can be long
  
  employeeID      Int
  trainingID      Int

  employee Employee @relation(fields: [employeeID], references: [empId], onDelete: Cascade, onUpdate: Cascade)
  training Training @relation(fields: [trainingID], references: [TrainingID])
}

model Certificate {
  CertificateID   Int     @id @default(autoincrement())
  agencyId        String?
  agency          Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  certificateName String?
  neededHours     Float?
  yearsValid      Float?
  filePath        String? // Path to uploaded certificate template or reference

  exclusions  CertificateTrainingExclusion[]
  expirations Expiration[]
}

model Policy {
  id          Int      @id @default(autoincrement())
  agencyId    String?
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  title       String
  content     String
  version     String   @default("1.0")
  createdAt   DateTime @default(now())
  
  acknowledgments PolicyAcknowledgment[]
}

model PolicyAcknowledgment {
  id          Int      @id @default(autoincrement())
  policyId    Int
  employeeId  Int
  acknowledgedAt DateTime @default(now())

  policy      Policy   @relation(fields: [policyId], references: [id])
  employee    Employee @relation(fields: [employeeId], references: [empId], onDelete: Cascade, onUpdate: Cascade)

  @@unique([policyId, employeeId])
}

model CertificateTrainingExclusion {
  exclusionID   Int @id @default(autoincrement()) // Synthetic ID as Access likely used composite key or no key
  certificateID Int
  trainingID    Int

  certificate Certificate @relation(fields: [certificateID], references: [CertificateID])
  training    Training    @relation(fields: [trainingID], references: [TrainingID])

  @@unique([certificateID, trainingID])
}

model Expiration {
  expirationID Int       @id @default(autoincrement()) // Synthetic ID
  CertificateID Int
  EmployeeID    Int
  Expiration    DateTime?
  documentPath  String?

  certificate Certificate @relation(fields: [CertificateID], references: [CertificateID])
  employee    Employee    @relation(fields: [EmployeeID], references: [empId], onDelete: Cascade, onUpdate: Cascade)
}

model FormTemplate {
  id          Int      @id @default(autoincrement())
  agencyId    String?
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  title       String
  type        String   @default("GENERAL") // GENERAL, RADIO, CALL_TAKING
  version     Int      @default(1)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  namingConvention String? // e.g., "{{trainee}} - Shift {{field:Shift}}"
  ratingScaleOptions String? // JSON array of scale labels (e.g. '["1","2","3","4","5","N.A."]')
  
  sections    FormSection[]
  responses   FormResponse[]
}

model FormSection {
  id          Int      @id @default(autoincrement())
  title       String
  order       Int
  
  templateId  Int
  template    FormTemplate @relation(fields: [templateId], references: [id])
  
  fields      FormField[]
}

model FormField {
  id          Int      @id @default(autoincrement())
  label       String
  type        String   // "RATING", "TEXT", "BOOLEAN"
  order       Int
  required    Boolean  @default(true)
  
  sectionId   Int
  section     FormSection @relation(fields: [sectionId], references: [id])
}

model FormResponse {
  id          Int      @id @default(autoincrement())
  date        DateTime @default(now())
  
  traineeId   Int
  trainee     Employee @relation("Trainee", fields: [traineeId], references: [empId], onDelete: Cascade, onUpdate: Cascade)
  
  trainerId   Int
  trainer     User     @relation("Trainer", fields: [trainerId], references: [id]) 

  templateId  Int
  template    FormTemplate @relation(fields: [templateId], references: [id])
  
  responseData String // JSON string storing { fieldId: value }
  customTitle  String? // Generated title based on namingConvention
  
  status      String   @default("DRAFT") // DRAFT, SUBMITTED, REVIEWED
  traineeSignatureAt DateTime?
}

model EISFlag {
  id          Int      @id @default(autoincrement())
  employeeId  Int
  type        String   // PERFORMANCE, ASSET, COMPLIANCE
  severity    String   // LOW, MEDIUM, HIGH
  description String   // "Avg Score 2.1 over last 5 days"
  
  status      String   @default("OPEN") // OPEN, RESOLVED, DISMISSED
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  resolutionNotes String?

  employee    Employee @relation(fields: [employeeId], references: [empId], onDelete: Cascade, onUpdate: Cascade)
}

model OrganizationSettings {
  id          Int      @id @default(autoincrement())
  agencyId    String?   @unique
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  orgName     String   @default("Orbit 911 Center")
  logoPath    String?  // Path to uploaded logo file
  
  licenseKey    String?
  licenseStatus String @default("ACTIVE") // ACTIVE, EXPIRED, INVALID
  licenseExpiry DateTime?
  
  updatedAt   DateTime @updatedAt
  
  modules     String?  // JSON array of enabled modules: ["INVENTORY", "EIS", "DOR"]
}

model IssuedLicense {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  clientName  String   // Who is this for?
  
  issuedAt    DateTime @default(now())
  expiresAt   DateTime?
  
  isActive    Boolean  @default(true)
}

model AuditLog {
  id          String   @id @default(uuid())
  agencyId    String?
  agency      Agency?   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  timestamp   DateTime @default(now())
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // "VIEW", "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  resource    String   // "Employee", "DOR", "Inventory"
  details     String?  // JSON details
  severity    String   @default("INFO") // "INFO", "WARN", "CRITICAL"
}

model EmailTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @unique // e.g., "Account Creation", "Agency Onboarding"
  
  subject     String
  body        String   // HTML or plain-text template blending text and variables
  variables   String   // JSON array of available variables (e.g., ["{{name}}", "{{email}}"])
  
  updatedAt   DateTime @updatedAt
}
